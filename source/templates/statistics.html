{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="card-title mb-0">Player Statistics</h2>
                    <div>
                        <a href="{{ url_for('all_statistics') }}" class="btn btn-primary">
                            <i class="bi bi-table"></i> View All Statistics
                        </a>
                        <a href="/" class="btn btn-outline-secondary">
                            <i class="bi bi-house"></i> Home
                        </a>
                    </div>
                </div>
                
                <div class="alert alert-info">
                    <i class="bi bi-info-circle-fill me-2"></i>
                    Select a position to view detailed statistics or search for a specific player.
                </div>
                
                <ul class="nav nav-tabs" id="positionTabs" role="tablist">
                    {% for position in positions_data.keys() %}
                    <li class="nav-item" role="presentation">
                        <button class="nav-link {% if loop.first %}active{% endif %}" 
                                id="{{ position }}-tab" 
                                data-bs-toggle="tab" 
                                data-bs-target="#{{ position }}" 
                                type="button" 
                                role="tab" 
                                aria-controls="{{ position }}"
                                aria-selected="{% if loop.first %}true{% else %}false{% endif %}">
                            {{ position }}
                        </button>
                    </li>
                    {% endfor %}
                </ul>
                
                <div class="tab-content p-3 border border-top-0 rounded-bottom" id="positionTabsContent">
                    {% if positions_data %}
                    {% for position, players in positions_data.items() %}
                    <div class="tab-pane fade {% if loop.first %}show active{% endif %}" 
                         id="{{ position }}" 
                         role="tabpanel" 
                         aria-labelledby="{{ position }}-tab">
                        <div class="table-responsive">
                            <table id="{{ position }}Table" class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        {% if players %}
                                            {% for key in players[0].keys() %}
                                                <th>{{ key }}</th>
                                            {% endfor %}
                                        {% endif %}
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for player in players %}
                                        <tr>
                                            {% for key, value in player.items() %}
                                                <td>
                                                    {% if key.lower() == 'player' or key.lower() == 'name' %}
                                                        <a href="{{ url_for('player_stats', player_name=value) }}" class="text-decoration-none">
                                                            {{ value }}
                                                        </a>
                                                    {% else %}
                                                        {{ value }}
                                                    {% endif %}
                                                </td>
                                            {% endfor %}
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center py-5">
                        <div class="mb-4">
                            <i class="bi bi-people display-1 text-muted"></i>
                        </div>
                        <h3>No Statistics Loaded</h3>
                        <p class="text-muted">
                            Player statistics are not currently loaded. Please check back later or contact support.
                        </p>
                        <a href="{{ url_for('all_statistics') }}" class="btn btn-primary mt-3">
                            <i class="bi bi-arrow-repeat"></i> Try Loading Statistics
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize DataTables for each position table
        const positionsData = {{ positions_data|tojson|safe if positions_data else '{}' }};
        
        if (Object.keys(positionsData).length > 0) {
            Object.keys(positionsData).forEach(function(position) {
                const tableId = position + 'Table';
                const tableElement = document.getElementById(tableId);
                
                if (tableElement) {
                    // Destroy existing DataTable if it exists
                    if ($.fn.DataTable.isDataTable('#' + tableId)) {
                        $('#' + tableId).DataTable().destroy();
                    }
                    
                    // Initialize new DataTable
                    $('#' + tableId).DataTable({
                        "pageLength": 25,
                        "order": [],
                        "responsive": true,
                        "dom": '<"top"f>rt<"bottom"lip><"clear">',
                        "language": {
                            "search": "Filter:",
                            "lengthMenu": "Show _MENU_ entries per page",
                            "info": "Showing _START_ to _END_ of _TOTAL_ entries",
                            "infoEmpty": "No entries found",
                            "infoFiltered": "(filtered from _MAX_ total entries)",
                            "paginate": {
                                "previous": "&laquo;",
                                "next": "&raquo;"
                            }
                        }
                    });
                }
            });
        }
    });
</script>
{% endblock %}
